#!/usr/bin/perl
use strict;
use Getopt::Long;
use SmokeReports::ParsedToDb qw(parse_report_to_db);
use SmokeReports::Dbh;

my $verbose;
GetOptions("v|verbose" => \$verbose);

++$|;

my $schema = SmokeReports::Dbh->schema;

my $reports = $schema->resultset('DailyBuildReport');

my $query = $reports->search
  (
   { 'parsed_report.nntp_id' => undef },
   { join => 'parsed_report' }
  );

my $total_count;
if ($verbose) {
  ($total_count) = $query->count;
  print "0 / $total_count\r";
}

my $done_count = 0;
while (my $report = $query->next) {
  parse_report_to_db($report, $verbose);
  ++$done_count;
  if ($verbose) {
    print "$done_count / $total_count\r";
  }
}
print "\n" if $verbose;
